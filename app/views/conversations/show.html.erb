<% if user_signed_in? %>
    <%= render 'home/sidebar' %>
<% end %>

<section class="homepage">
  <div class="conversation-container container">
    
    <% if @conversation.item != nil %>
      <div id="conversation-id" data-conversation-id="<%= @conversation.try(:id) %>"></div>
      <div id="user-id" data-user-id="<%= current_user.id %>"></div>

      <!-- getting username of current_user's conversation partner -->
      <% if @conversation.item.user == current_user && current_user.id == @conversation.user2_id %>
        <span><% convo_partner = User.find(@conversation.user1_id).username %></span>
      <% elsif @conversation.item.user == current_user && current_user.id == @conversation.user1_id %>
        <span><% convo_partner = User.find(@conversation.user2_id).username %></span>  
      <% else %>
        <span><% convo_partner = @conversation.item.user.username %></span>  
      <% end %>

      <div class="d-flex justify-content-between align-items-center mb-2 mt-2">
        <div>
          <span><%= @conversation.item.name %></span>
          <span class="convo_partner"><%= convo_partner %></span>
        </div>

        <div class="item-status-update d-flex justify-content-around">
            <% disabled = @conversation.item.status == 'traded' %>

            <% if @conversation.item.status != 'reserved'%>
                <%= form_with scope: :item, method: :patch, url: item_path(@conversation.item), local: true do |f| %>
                    <%= f.hidden_field :status, value: "reserved" %>
                    <%= f.submit "Mark as Reserved", disabled: disabled, class: "btn btn-primary" %>
                <% end %>
            <% else %>
                <%= form_with scope: :item, method: :patch, url: item_path(@conversation.item), local: true do |f| %>
                    <%= f.hidden_field :status, value: "open" %>
                    <%= f.submit "Mark as Open", disabled: disabled, class: "btn btn-primary" %>
                <% end %>
            <% end %>

            <% if @conversation.item.status != 'traded' %>
                <%= form_with scope: :item, method: :patch, url: item_path(@conversation.item), local: true do |f| %>
                    <%= f.hidden_field :status, value: "traded" %>
                    <%= f.submit "Mark as Traded", class: "btn btn-primary" %>
                <% end %>
            <% else %>
                <%= form_with scope: :item, method: :patch, url: item_path(@conversation.item), local: true do |f| %>
                    <%= f.hidden_field :status, value: "open" %>
                    <%= f.submit "Unmark as Traded", class: "btn btn-primary" %>
                <% end %>
            <% end %>
        </div>
      </div> 

      <div class="messages-container mb-2 rounded-lg" id="messages-container">
        <% @conversation.messages.each do |message| %>
          <%= render 'messages/message', message: message %>
        <% end %>
      </div>

      <div class="message-form">
        <%= render 'messages/form' %>
      </div>

    <% else %>
      <h1>Item has been removed by User</h1>
    <% end %>

  </div>
</section>
